name: Auto Update Blog with AI

on:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ, ì˜¤í›„ 3ì‹œ, ì˜¤í›„ 9ì‹œ (KST = UTC+9)
    - cron: '0 0,6,12 * * *'  # UTC 0ì‹œ, 6ì‹œ, 12ì‹œ = KST 9ì‹œ, 15ì‹œ, 21ì‹œ
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      enable_ai:
        description: 'AI ì½˜í…ì¸  ìƒì„± í™œì„±í™”'
        required: false
        default: 'true'
        type: choice
        options:
          - 'true'
          - 'false'

permissions:
  contents: write
  pull-requests: write   # PR ìƒì„± ê¶Œí•œ ì¶”ê°€


jobs:
  update-blog:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd automation
        pip install -r requirements.txt
        
    - name: âœï¸ Step 1 - ì£¼ì œ ì„ ì •
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      run: |
        echo "ğŸ¯ Step 1: ë¸”ë£¨ì˜¤ì…˜ í‚¤ì›Œë“œ ë°œêµ´ ì¤‘..."
        python automation/step1_topic_agent.py
    
    - name: ğŸ“ Step 2 - ê¸€ ì‘ì„±
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      run: |
        echo "ğŸ“ Step 2: êµ¬ì¡°í™”ëœ ì½˜í…ì¸  ì‘ì„± ì¤‘..."
        python automation/step2_writer_agent.py
    
    - name: ğŸ¨ Step 3 - ì´ë¯¸ì§€ ìƒì„± ë° ê²€ìˆ˜
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        HUGGINGFACE_API_TOKEN: ${{ secrets.HUGGINGFACE_API_TOKEN }}  # â¬…ï¸ ì´ ì¤„ ì¶”ê°€!
      run: |
        echo "ğŸ¨ Step 3: ì´ë¯¸ì§€ ìƒì„± ë° Gemini Vision ê²€ìˆ˜ ì¤‘..."
        python automation/step3_image_audit_agent.py
    
    - name: ğŸ’¾ Step 4 - data.json ì €ì¥
      if: ${{ github.event.inputs.enable_ai != 'false' }}
      run: |
        echo "ğŸ’¾ Step 4: data.json ë° Markdown íŒŒì¼ ìƒì„± ì¤‘..."
        python automation/step4_save_to_data_json.py
        
    - name: ğŸ”¨ ë¸”ë¡œê·¸ ë¹Œë“œ (Markdown â†’ HTML)
      run: |
        echo "ğŸ”¨ build_blog.py ì‹¤í–‰ ì¤‘..."
        python automation/build_blog.py
        echo "âœ… ë¸”ë¡œê·¸ ë¹Œë“œ ì™„ë£Œ"
        
    
    - name: ğŸ“Š data.json ì´ë™
      run: |
        if [ -f automation/data.json ]; then
          cp automation/data.json data.json
          echo "âœ… data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        else
          echo "âŒ data.json ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
        - name: ğŸ“‹ ê²€ìˆ˜ìš© PR ìƒì„±
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # ë³€ê²½ì‚¬í•­ í™•ì¸
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add data.json data/ feed/ contents/ automation/generated_images/ automation/intermediate_outputs/
        
        if ! git diff --staged --quiet; then
          # ë¸Œëœì¹˜ëª… ìƒì„± (ë‚ ì§œ ê¸°ë°˜)
          BRANCH_NAME="ai-review-$(date +'%Y%m%d-%H%M%S')"
          
          # ì£¼ì œ ì¶”ì¶œ
          TOPIC=$(cat automation/intermediate_outputs/step1_topic.json | jq -r '.title' || echo "AI ìƒì„± í¬ìŠ¤íŠ¸")
          
          # ìƒˆ ë¸Œëœì¹˜ ìƒì„± ë° ì´ë™
          git checkout -b $BRANCH_NAME
          
          # ì»¤ë°‹
          git commit -m "ğŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC"
          
          # í‘¸ì‹œ
          git push origin $BRANCH_NAME
          
          # PR ìƒì„±
          gh pr create \
            --title "ğŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC" \
            --body "## ğŸ“ AIê°€ ìƒˆë¡œìš´ í¬ìŠ¤íŒ…ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤

**ì œëª©:** $TOPIC

**ì‘ì„± ì‹œê°:** $(date +'%Y-%m-%d %H:%M')

---

### âœ… ê²€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ 
- [ ] ì´ë¯¸ì§€ í™•ì¸ (automation/generated_images/)
- [ ] ì´ë¯¸ì§€ê°€ ì£¼ì œì™€ ë§ëŠ”ì§€ (ìˆ˜ì˜/ìŠ¤í¬ì¸  ì´ë¯¸ì§€ X)
- [ ] ë‚´ìš© í™•ì¸ (contents/*.md)
- [ ] ì˜¤íƒ€ ë° ë¬¸ë²• í™•ì¸

### ğŸ“Œ ë‹¤ìŒ ë‹¨ê³„
1. **ìŠ¹ì¸:** [Merge pull request] í´ë¦­ â†’ ë¸”ë¡œê·¸ ìë™ ë°°í¬
2. **ìˆ˜ì •:** Files changed íƒ­ì—ì„œ íŒŒì¼ ìˆ˜ì •
3. **ê±°ë¶€:** Close pull request â†’ ê¸€ íê¸°

### ğŸ”§ ë¬¸ì œ ë°œê²¬ ì‹œ
- **ì´ë¯¸ì§€ ì´ìƒ:** PR ë‹«ê³  ì›Œí¬í”Œë¡œìš° ì¬ì‹¤í–‰ (ëœë¤ ì‹œë“œë¡œ ë‹¤ë¥¸ ì´ë¯¸ì§€ ìƒì„±)
- **ë‚´ìš© ìˆ˜ì •:** Files changed â†’ ì—°í•„ ì•„ì´ì½˜ìœ¼ë¡œ ì§ì ‘ ìˆ˜ì •

---

**ë¯¸ë¦¬ë³´ê¸°:**
- Files changed íƒ­ì—ì„œ ì´ë¯¸ì§€ í´ë¦­í•˜ë©´ ë¯¸ë¦¬ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤" \
            --base main \
            --head $BRANCH_NAME \
            --label "ai-generated,needs-review"
          
          echo "âœ… PR ìƒì„± ì™„ë£Œ: $BRANCH_NAME"
          echo "ğŸ“± ëª¨ë°”ì¼/PCì—ì„œ GitHub ì•Œë¦¼ì„ í™•ì¸í•˜ì„¸ìš”!"
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ (PR ìƒì„± ì•ˆ í•¨)"
        fi

