name: Auto Update Blog with AI

on:
  schedule:
    - cron: '0 0,6,12 * * *' # ë§¤ì¼ 09:00, 15:00, 21:00 KST
  workflow_dispatch:
    inputs:
      manual_topic:
        description: 'ì£¼ì œë¥¼ ì…ë ¥í•˜ì„¸ìš” (ë¹„ì›Œë‘ë©´ AIê°€ ìë™ ì„ ì •)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  update-blog:
    runs-on: ubuntu-latest
    env:
      PYTHONPATH: ${{ github.workspace }} # íŒŒì´ì¬ ê²½ë¡œ ëª…ì‹œ

    steps:
    - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: ğŸ Python ì„¤ì •
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
        
    - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        cd automation
        pip install -r requirements.txt
        
    # ----------------------------------------------------------------
    # [Step 1] ì£¼ì œ ì„ ì • (ìŠ¤ë§ˆíŠ¸ í•˜ì´ë¸Œë¦¬ë“œ ëª¨ë“œ)
    # ----------------------------------------------------------------
    - name: ğŸš€ Step 1 - ì£¼ì œ ì„ ì • (ìë™ vs ìˆ˜ë™)
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        MANUAL_TOPIC: ${{ github.event.inputs.manual_topic }}
      run: |
        mkdir -p automation/intermediate_outputs
        
        # 1. ì…ë ¥ê°’ì´ ì—†ê±°ë‚˜ "ìë™"ì´ë©´ -> AIê°€ ì•Œì•„ì„œ ì„ ì • (ê¸°ì¡´ ë°©ì‹)
        if [[ -z "$MANUAL_TOPIC" || "$MANUAL_TOPIC" == "ìë™" ]]; then
          echo "ğŸ¤– [ìë™ ëª¨ë“œ] AIê°€ ë¸”ë£¨ì˜¤ì…˜ í‚¤ì›Œë“œë¥¼ ë°œêµ´í•©ë‹ˆë‹¤..."
          python automation/step1_topic_agent.py
          
        # 2. ì£¼ì œê°€ ì…ë ¥ë˜ë©´ -> ê·¸ ì£¼ì œë¡œ ê°•ì œ ì„¤ì • (ìˆ˜ë™ ë°©ì‹)
        else
          echo "ğŸ“ [ìˆ˜ë™ ëª¨ë“œ] ì§€ì •ëœ ì£¼ì œë¡œ ê¸€ì„ ì‘ì„±í•©ë‹ˆë‹¤: $MANUAL_TOPIC"
          # íŒŒì´ì¬ ì›ë¼ì´ë„ˆë¡œ topic.json íŒŒì¼ ì¦‰ì‹œ ìƒì„±
          python3 -c "import json; import os; topic = os.environ['MANUAL_TOPIC']; data = {'title': topic, 'search_keywords': [topic]}; print(json.dumps(data, ensure_ascii=False))" > automation/intermediate_outputs/step1_topic.json
        fi
        
        # ê²°ê³¼ í™•ì¸
        echo "âœ… ìµœì¢… í™•ì • ì£¼ì œ:"
        cat automation/intermediate_outputs/step1_topic.json
    
    # ----------------------------------------------------------------
    # [Step 2 ~ 4] ì½˜í…ì¸  ìƒì„± íŒŒì´í”„ë¼ì¸
    # (ìˆ˜ë™ ì‹¤í–‰ ì‹œì—ë„ ë¬´ì¡°ê±´ ëŒë„ë¡ if ì¡°ê±´ì„ ì œê±°í–ˆìŠµë‹ˆë‹¤)
    # ----------------------------------------------------------------
    - name: ğŸ“ Step 2 - ê¸€ ì‘ì„±
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
      run: |
        echo "ğŸ“ Step 2: êµ¬ì¡°í™”ëœ ì½˜í…ì¸  ì‘ì„± ì¤‘..."
        python automation/step2_writer_agent.py
    
    - name: ğŸ¨ Step 3 - ì´ë¯¸ì§€ ìƒì„± ë° ê²€ìˆ˜
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        GEMINI_API_KEYS: ${{ secrets.GEMINI_API_KEYS }}
        HUGGINGFACE_API_TOKEN: ${{ secrets.HUGGINGFACE_API_TOKEN }} 
      run: |
        echo "ğŸ¨ Step 3: ì´ë¯¸ì§€ ìƒì„± ë° Gemini Vision ê²€ìˆ˜ ì¤‘..."
        python automation/step3_image_audit_agent.py
    
    - name: ğŸ’¾ Step 4 - data.json ì €ì¥
      env:
        GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}  # (ë²ˆì—­ í•„ìš”ì‹œ ì‚¬ìš©, í˜„ì¬ëŠ” ìµœì í™”ë¨)
      run: |
        echo "ğŸ’¾ Step 4: data.json ë° Markdown íŒŒì¼ ìƒì„± ì¤‘..."
        python automation/step4_save_to_data_json.py
        
    # ----------------------------------------------------------------
    # [ë¹Œë“œ ë° ë°°í¬]
    # ----------------------------------------------------------------
    - name: ğŸ”¨ ë¸”ë¡œê·¸ ë¹Œë“œ (RSS/HTML)
      run: |
        echo "ğŸ”¨ build_blog.py ì‹¤í–‰ ì¤‘..."
        python automation/build_blog.py
        echo "âœ… ë¸”ë¡œê·¸ ë¹Œë“œ ì™„ë£Œ"
    
    - name: ğŸ“Š data.json ì´ë™
      run: |
        if [ -f automation/data.json ]; then
          cp automation/data.json data.json
          echo "âœ… data.json ì—…ë°ì´íŠ¸ ì™„ë£Œ"
        else
          echo "âŒ data.json ìƒì„± ì‹¤íŒ¨"
          exit 1
        fi
        
    - name: ğŸ“‹ ê²€ìˆ˜ìš© PR ìƒì„±
      env:
        GH_TOKEN: ${{ secrets.MY_PAT }} 
        TZ: 'Asia/Seoul'
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        # [ì•ˆì „ì¥ì¹˜] íŒŒì¼ì´ ì¡´ì¬í•  ë•Œë§Œ add
        git add data.json || true
        git add contents/ || true
        git add automation/generated_images/ || true
        git add feed/ || true
        
        if ! git diff --staged --quiet; then
          # ---------------------------------------------------------
          # [ê´€ë¦¬ì ì•Œë¦¼] ìƒì„±ëœ íŒŒì¼ ëª©ë¡ ì¶œë ¥
          # ---------------------------------------------------------
          echo "========================================================"
          echo "ğŸ“‚ [ê´€ë¦¬ì í™•ì¸ìš©] ìƒì„± ë° ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡"
          echo "========================================================"
          git diff --staged --name-only | sed 's/^/ğŸ‘‰ /'
          echo "========================================================"
          
          CURRENT_DATE=$(date +'%Y%m%d-%H%M%S')
          BRANCH_NAME="ai-review-$CURRENT_DATE"
          
          if [ -f automation/intermediate_outputs/step1_topic.json ]; then
            TOPIC=$(cat automation/intermediate_outputs/step1_topic.json | jq -r '.title')
          else
            TOPIC="AI ìë™ ìƒì„± í¬ìŠ¤íŠ¸ ($CURRENT_DATE)"
          fi
          
          git checkout -b $BRANCH_NAME
          git commit -m "ğŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC"
          git push origin $BRANCH_NAME
          
          # ---------------------------------------------------------
          # PR ë³¸ë¬¸ ì‘ì„±
          # ---------------------------------------------------------
          PR_TITLE="ğŸ¤– [ê²€ìˆ˜ ìš”ì²­] $TOPIC"
          CURRENT_TIME=$(date +'%Y-%m-%d %H:%M:%S')
          
          printf "## ğŸ“ AIê°€ ìƒˆë¡œìš´ í¬ìŠ¤íŒ…ì„ ì‘ì„±í–ˆìŠµë‹ˆë‹¤\n\n" > /tmp/pr_body.md
          printf "**ì£¼ì œ:** %s\n" "$TOPIC" >> /tmp/pr_body.md
          printf "**ì‘ì„± ì‹œê°:** %s (KST)\n\n" "$CURRENT_TIME" >> /tmp/pr_body.md
          
          printf "%s\n" "---" >> /tmp/pr_body.md
          
          printf "### âœ… ê²€ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸\n" >> /tmp/pr_body.md
          printf "%s\n" "- [ ] **ì´ë¯¸ì§€:** \`automation/generated_images/\` í´ë” í™•ì¸" >> /tmp/pr_body.md
          printf "%s\n" "- [ ] **ë‚´ìš©:** \`contents/\` í´ë”ì˜ Markdown íŒŒì¼ í™•ì¸" >> /tmp/pr_body.md
          printf "%s\n" "- [ ] **ë©”íƒ€ë°ì´í„°:** \`data.json\` ì—…ë°ì´íŠ¸ í™•ì¸" >> /tmp/pr_body.md
          printf "\n" >> /tmp/pr_body.md
          
          printf "### ğŸ“Œ ê´€ë¦¬ì í–‰ë™ ê°€ì´ë“œ\n" >> /tmp/pr_body.md
          printf "1. **ìŠ¹ì¸:** [Merge pull request] í´ë¦­ â†’ ë°°í¬\n" >> /tmp/pr_body.md
          printf "2. **ìˆ˜ì •:** [Files changed] íƒ­ â†’ Edit file â†’ ìˆ˜ì •\n" >> /tmp/pr_body.md
          printf "3. **ë°˜ë ¤:** [Close pull request] í´ë¦­ â†’ íê¸°\n\n" >> /tmp/pr_body.md
          
          printf "%s\n" "---" >> /tmp/pr_body.md
          printf "ğŸ¤– *This content was generated by Gemini AI Pipeline.*\n" >> /tmp/pr_body.md
          
          # PR ìƒì„±
          gh pr create \
            --title "$PR_TITLE" \
            --body-file /tmp/pr_body.md \
            --base main \
            --head $BRANCH_NAME \
            --label "ai-generated" \
            --label "needs-review"
          
          echo "âœ… PR ìƒì„± ì™„ë£Œ: $BRANCH_NAME"
        else
          echo "â„¹ï¸ ë³€ê²½ì‚¬í•­ ì—†ìŒ"
        fi

    # [ë””ë²„ê¹…] ì‹¤íŒ¨ ì‹œ ë¡œê·¸ ì¶œë ¥
    - name: ğŸ” (ì‹¤íŒ¨ ì‹œ) ë””ë²„ê¹… íŒŒì¼ ëª©ë¡ í™•ì¸
      if: failure()
      run: |
        echo "========================================================"
        echo "ğŸ [ë””ë²„ê¹…] ì¤‘ê°„ ì‚°ì¶œë¬¼ íŒŒì¼ ê²½ë¡œ ì•ˆë‚´"
        echo "========================================================"
        if [ -d "automation/intermediate_outputs" ]; then
          ls -R automation/intermediate_outputs/ | sed 's/^/ğŸ“„ /'
        else
          echo "âš ï¸ ì¤‘ê°„ ì‚°ì¶œë¬¼ í´ë”ê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤."
        fi
        echo "========================================================"
